name: Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (no tags/releases created)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  lint:
    if: github.repository == 'axone-protocol/contracts' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/lint.yml

  build:
    if: github.repository == 'axone-protocol/contracts' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/build.yml

  test:
    if: github.repository == 'axone-protocol/contracts' && github.ref == 'refs/heads/main'
    uses: ./.github/workflows/test.yml

  check-configured-projects:
    if: github.repository == 'axone-protocol/contracts' && github.ref == 'refs/heads/main'
    needs: [lint, build, test]
    runs-on: ubuntu-22.04
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - id: set-matrix
        run: |
          PROJECT_DIRS=$(find contracts packages -maxdepth 2 -name "pyproject.toml" -print0 \
            | xargs -0 -n1 dirname \
            | jq -R -s -c 'split("\n")[:-1]')

          echo "Found projects: $PROJECT_DIRS"
          echo "matrix=$PROJECT_DIRS" >> $GITHUB_OUTPUT

  release:
    needs: check-configured-projects
    if: ${{ needs.check-configured-projects.outputs.matrix != '[]' && needs.check-configured-projects.outputs.matrix != '' }}
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        project_dir: ${{ fromJSON(needs.check-configured-projects.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.OPS_TOKEN }}

      - name: Configure git author from token
        run: |
          BOT_NAME=$(gh api user --jq .login)
          BOT_EMAIL="${BOT_NAME}@users.noreply.github.com"
          git config user.name "${BOT_NAME}"
          git config user.email "${BOT_EMAIL}"
          echo "Configured git author: ${BOT_NAME} <${BOT_EMAIL}>"
        env:
          GH_TOKEN: ${{ secrets.OPS_TOKEN }}

      - name: Sync to latest remote
        run: |
          git fetch --tags origin
          git fetch origin "+refs/heads/*:refs/remotes/origin/*"
          git checkout "${GITHUB_REF_NAME}"
          git reset --hard "origin/${GITHUB_REF_NAME}"

      - name: Cache cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Setup rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install cargo make
        uses: davidB/rust-cargo-make@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build WASM artifacts
        run: cargo make release-wasm

      - name: Python Semantic Release (Dry Run)
        if: github.event.inputs.dry_run == 'true'
        run: |
          pip install "python-semantic-release>=10,<11"
          cd ${{ matrix.project_dir }}
          semantic-release -vv --noop version
        env:
          GH_TOKEN: ${{ secrets.OPS_TOKEN }}

      - name: Python Semantic Release (Real)
        if: github.event.inputs.dry_run != 'true'
        uses: python-semantic-release/python-semantic-release@v10
        with:
          directory: ${{ matrix.project_dir }}
          github_token: ${{ secrets.OPS_TOKEN }}
          verbosity: 1
          strict: true
